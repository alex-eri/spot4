#!/usr/bin/make -f

CURRENT_YM := $(shell date -d "`git log -1 --format=%ci`" +"%y%m")
CURRENT_COMMIT := $(shell git rev-parse --short HEAD)
CURRENT_NCMMIT := $(shell git rev-list --all --count)
EMAIL := "sa@eri.su"
SNAPSHOTRELEASE := "--snapshot"

clean:
	rm -rf debian/spot4

build-arch:
	make -C . build/config build/bin
	#git reset -- debian/changelog
	rm -f debian/changelog.dch
	EMAIL=$(EMAIL) gbp dch $(SNAPSHOTRELEASE) --git-author --spawn-editor=no --new-version=$(CURRENT_YM) --snapshot-number=$(CURRENT_NCMMIT) 
	#--commit 

binary-arch: build-arch
	mkdir -p debian/spot4/opt/spot4/
	mkdir -p debian/spot4/etc/systemd/system
	mkdir -p debian/spot4/etc/firewalld/services
	ln -s /opt/spot4/config/ debian/spot4/etc/spot4
	cp -R build/bin build/config debian/spot4/opt/spot4/
	cp debian/spot4/opt/spot4/config/config.json.example debian/spot4/opt/spot4/config/config.json
	cp systemd/spot.service debian/spot4/etc/systemd/system/
	cp systemd/firewalld-services-spot.xml debian/spot4/etc/firewalld/services/spot.xml
	dh_gencontrol
	cp debian/postinst debian/spot4/DEBIAN/
	cp debian/conffiles debian/spot4/DEBIAN/
	dh_builddeb





